server {
  listen 80 default_server;
  server_name _;

  client_max_body_size 1024m;

  location = /healthz {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # Allow both /team8/team8-media/* (through core proxy) and direct /team8-media/*
  location /team8/team8-media/ {
    rewrite ^/team8/(team8-media/.*)$ /$1 break;
    proxy_pass http://minio:9000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /team8-media/ {
    proxy_pass http://minio:9000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Backend API (put this BEFORE /team8/ frontend)
  location /team8/api/ {
    proxy_pass http://backend:8002/api/;  # /team8/api/x -> /api/x
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;  # Forward auth cookies
  }

  # AI Service
  location /team8/ai/ {
    proxy_pass http://ai-service:8001/;  # /team8/ai/x -> /x
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Optional convenience for local development (/api -> backend)
  location /api/ {
    proxy_pass http://backend:8002/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;  # Forward auth cookies
  }

  # Frontend
  location /team8/ {
    proxy_pass http://frontend:80;  # keep URI as-is
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location = / {
    return 302 /team8/;
  }
}
